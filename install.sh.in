#!/bin/bash

CC="/usr/lib/llvm-14/bin/clang"
CXX="/usr/lib/llvm-14/bin/clang++"

BAZEL=@BAZEL@

HWY_INCLUDE_PATH=$(${BAZEL} query @hwy --output=location --noshow_loading_progress 2>/dev/null | cut -f1 -d' ' | xargs -n1 dirname)

if [ -z "$HWY_INCLUDE_PATH" ]; then
    echo "Could not find hwy"
    exit 1
fi

INCLUDE="-I. -I$HWY_INCLUDE_PATH"
CXXFLAGS="-S -emit-llvm -O2 -UPRISM_DEBUG -std=c++17"

# Baseline target
$CXX $CXXFLAGS $INCLUDE src/ud_vector.cpp -o ud_hw.ll &
$CXX $CXXFLAGS $INCLUDE src/sr_vector.cpp -o sr_hw.ll &

# Native target
CXXFLAGS+=" -march=native -DHWY_COMPILE_ONLY_STATIC "
$CXX $CXXFLAGS $INCLUDE src/ud_vector.cpp -o ud_hw-native.ll &
$CXX $CXXFLAGS $INCLUDE src/sr_vector.cpp -o sr_hw-native.ll &

wait

bazelisk build src:prism-all

prefix=@prefix@
exec_prefix=@exec_prefix@
INSTALL_LIB_PREFIX=@libdir@

echo "Copying libprism* to $INSTALL_LIB_PREFIX"
chmod u+w bazel-bin/src/libprism*.{a,so}
cp bazel-bin/src/libprism*.{a,so} $INSTALL_LIB_PREFIX
